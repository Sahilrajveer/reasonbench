name: Monthly reminder to maintain reasonbench

on:
  schedule:
    # Run at 09:00 UTC on the second Monday of each month
    - cron: "0 9 8-14 * 1"
  workflow_dispatch:

jobs:
  monthly-reminder:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Find existing reminder issue
        id: find_issue
        run: |
          ISSUE_NUMBER=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues?state=open&per_page=100" |
            jq -r '.[] | select(.title == "ðŸ“… Monthly maintenance reminder") | .number')
          
          if [ -n "$ISSUE_NUMBER" ]; then
            echo "Found issue #$ISSUE_NUMBER"
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "No existing issue found."
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi

      - name: Add comment to existing issue
        if: steps.find_issue.outputs.issue_number != ''
        run: |
          COMMENT="ðŸ‘‹ Hey @DiogoRibeiro7 â€” it's your **monthly reminder** to check in on \`reasonbench\`!  

          **Tasks to consider:**
          - ðŸ§© Review open issues and PRs  
          - ðŸ§ª Run \`devtools::check()\` locally  
          - ðŸ“š Update vignettes and documentation  
          - ðŸš€ Review the [ROADMAP.md](https://github.com/DiogoRibeiro7/reasonbench/blob/main/ROADMAP.md)  
          - ðŸ§  Plan next benchmarking features  

          _Triggered automatically on $(date -u '+%Y-%m-%d %H:%M UTC')._"

          COMMENT_ESCAPED=$(echo "$COMMENT" | jq -Rs .)
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"body\": $COMMENT_ESCAPED}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.find_issue.outputs.issue_number }}/comments"

      - name: Create new reminder issue if none exists
        if: steps.find_issue.outputs.issue_number == ''
        uses: peter-evans/create-issue-from-file@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "ðŸ“… Monthly maintenance reminder"
          content-filepath: .github/reminder-message.md
          labels: maintenance, reminder
