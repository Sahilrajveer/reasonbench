name: Monthly reminder to maintain reasonbench

on:
  schedule:
    # Second Monday of each month at 09:00 UTC
    - cron: "0 9 8-14 * 1"
  workflow_dispatch:

jobs:
  monthly-reminder:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      # 1️⃣ Find issue by title
      - name: Find existing reminder issue
        id: find_issue
        run: |
          ISSUE_NUMBER=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues?state=open&per_page=100" |
            jq -r '.[] | select(.title == "📅 Monthly maintenance reminder") | .number')
          
          if [ -n "$ISSUE_NUMBER" ]; then
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi

      # 2️⃣ Create issue if it doesn't exist
      - name: Create new reminder issue if none exists
        if: steps.find_issue.outputs.issue_number == ''
        id: create_issue
        uses: peter-evans/create-issue-from-file@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "📅 Monthly maintenance reminder"
          content-filepath: .github/reminder-message.md
          labels: maintenance, reminder

      # 3️⃣ Add comment (always runs — on new or existing issue)
      - name: Add reminder comment
        run: |
          ISSUE_NUMBER="${{ steps.find_issue.outputs.issue_number || steps.create_issue.outputs.issue-number }}"
          COMMENT="👋 Hey @DiogoRibeiro7 — it's your **monthly reminder** to check in on \`reasonbench\`!  

          **Suggested actions:**
          - 🧩 Review open issues and PRs  
          - 🧪 Run \`devtools::check()\` locally  
          - 📚 Update vignettes and documentation  
          - 🚀 Review [ROADMAP.md](https://github.com/DiogoRibeiro7/reasonbench/blob/main/ROADMAP.md)  
          - 🧠 Plan new benchmarking improvements  

          _Triggered automatically on $(date -u '+%Y-%m-%d %H:%M UTC')._"

          COMMENT_ESCAPED=$(echo "$COMMENT" | jq -Rs .)
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"body\": $COMMENT_ESCAPED}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments"
